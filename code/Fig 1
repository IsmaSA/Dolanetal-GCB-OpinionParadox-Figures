

# Opinon piece dam constructions figure
library(ggplot2)
library(dplyr)
library(readxl)
library(sf)
library(tidyr)
library(boot)

DamConstructionEU <- st_read("C:/Users/User/OneDrive - Queen's University Belfast/PhD/Chapters/Chapter 3 Global Connectivity (InvaPact)//GDW_barriers_v1_0.shp")

# remove dams without year of contruction
# there should be 15,230 with this
DamConstructionEU <- DamConstructionEU %>% drop_na(YEAR_DAM)

DamConstructionEU <- DamConstructionEU %>%
  filter(YEAR_DAM != -99)


#Then split the countries into their
#install.packages("countrycode")
library(countrycode)

DamConstructionEU$CONTINENT <- countrycode(sourcevar = DamConstructionEU$COUNTRY,
                                               origin = "country.name",
                                               destination = "continent")

DamConstructionEU$REGION <- countrycode(sourcevar = DamConstructionEU$COUNTRY,
                                        origin = "country.name",
                                        destination = "region")


# north/south america (for this caribean will be with latin america)
DamConstructionEU <- DamConstructionEU %>%
  mutate(CONTINENT = case_when(
    REGION == "North America" ~ "North America",  
    REGION == "Latin America & Caribbean" ~ "South America",  
    TRUE ~ CONTINENT
  ))

# Kovoso
DamConstructionEU <- DamConstructionEU %>%
  mutate(CONTINENT = ifelse(COUNTRY == "Kosovo", "Europe", CONTINENT))


#############
# specifying continent countries ############
DamConstructionEU$CONTINENT <- countrycode(sourcevar = DamConstructionEU$COUNTRY,
                                           origin = "country.name",
                                           destination = "continent")

DamConstructionEU <- DamConstructionEU %>%
  mutate(CONTINENT = case_when(
    COUNTRY %in% c("United States", "Canada", "Mexico") ~ "North America",
    COUNTRY %in% c("Brazil", "Argentina", "Chile", "Colombia") ~ "South America",
    TRUE ~ CONTINENT  # Keep other continents as is
  ))
##################

### code for doing continent/country separation using the shapefile #######
install.packages(c("rnaturalearth", "sf", "dplyr"))
library(rnaturalearth)
library(sf)
library(dplyr)

world <- ne_countries(scale = "medium", returnclass = "sf")
DamConstructionEU_sf <- left_join(DamConstructionEU_sf, world, by = c("COUNTRY" = "name"))
DamConstructionEU_sf$CONTINENT <- DamConstructionEU_sf$continent
######################

#########################

# number of dams removed per continent of years
Dam_Construction_per_year <- DamConstructionEU %>%
  group_by(YEAR_DAM, CONTINENT) %>%
  summarise(no_const = n_distinct(GDW_ID)) %>%
  ungroup() 

# year limits
Dam_Construction_per_year_filtered <- Dam_Construction_per_year %>%
  filter(YEAR_DAM >= 1800 & YEAR_DAM <= 2024) 

# remove continent NAs 
Dam_Construction_per_year_filtered <- Dam_Construction_per_year_filtered %>%
  filter(!is.na(CONTINENT))

# remove the one called Americas
Dam_Construction_per_year_filtered <- Dam_Construction_per_year_filtered %>%
  filter(CONTINENT != "Americas")


# group by decades????

# scatterplot of the number of barriers per year (not cumulative) across continents
ggplot(Dam_Construction_per_year_filtered, aes(x = YEAR_DAM, y = no_const, color = CONTINENT)) +
  geom_line() + 
  geom_point() +
  scale_x_continuous(breaks = seq(1880, 2024, by = 10), limits = c(1880, 2024)) + 
  labs(x = "Year", y = "Number of Dam Constructions", color = "Continent") + 
  theme_minimal() + 
  theme(
    text = element_text(size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate x-axis labels
  )



# LOESS and bootstrapping #########
loess_boot <- function(Dam_Construction_per_year_filtered, indices) {
  d <- Dam_Construction_per_year_filtered[indices, ]
  loess_fit <- loess(no_const ~ YEAR_DAM, data = d)
  return(predict(loess_fit, newdata = data.frame(YEAR_DAM = Dam_Construction_per_year_filtered$YEAR_DAM)))
}

set.seed(123)

boot_loess <- boot(Dam_Construction_per_year_filtered, loess_boot, R = 1000)

ci_loess <- apply(boot_loess$t, 2, function(x) quantile(x, probs = c(0.025, 0.975), na.rm = TRUE))

Dam_Construction_per_year_filtered$lower_ci <- ci_loess[1, ]
Dam_Construction_per_year_filtered$upper_ci <- ci_loess[2, ]

#### LOESS with all CI for all continents
set.seed(123)

loess_boot <- function(data, indices) {
  d <- data[indices, ]
  loess_fit <- loess(no_const ~ YEAR_DAM, data = d, span = 0.3)
  return(predict(loess_fit, newdata = data.frame(YEAR_DAM = data$YEAR_DAM)))
}

ci_loess_all <- data.frame()

for (cont in unique(Dam_Construction_per_year_filtered$CONTINENT)) {
  data_cont <- Dam_Construction_per_year_filtered[Dam_Construction_per_year_filtered$CONTINENT == cont, ]
  boot_loess <- boot(data_cont, loess_boot, R = 1000)
  ci_loess <- apply(boot_loess$t, 2, function(x) quantile(x, probs = c(0.025, 0.975), na.rm = TRUE))
  data_cont$lower_ci <- ci_loess[1, ]
  data_cont$upper_ci <- ci_loess[2, ]
  ci_loess_all <- rbind(ci_loess_all, data_cont)
}






# plot 
ggplot(Dam_Construction_per_year_filtered, aes(x = YEAR_DAM, y = no_const, color = CONTINENT)) +
  geom_point() +
  geom_line(stat = "smooth", method = "loess", se = FALSE) +  
  labs(x = "Year", y = "Number of Barriers per Year") +
  theme_minimal()
####################



# plotting with loess 
ggplot(Dam_Construction_per_year_filtered, aes(x = YEAR_DAM, y = no_const, color = CONTINENT)) +
  #geom_line() + 
  #geom_point() +
  geom_smooth(method = "loess", span = 0.3, se = FALSE, size = 1) +  
  scale_x_continuous(breaks = seq(1880, 2022, by = 10), limits = c(1880, 2022)) +  
  labs(x = "Year", y = "Number of Dam Constructions", color = "Continent") +  
  theme_minimal() + 
  theme(
    panel.grid.major = element_line(size = 0.5, color = "lightgrey"),  
    panel.grid.minor = element_blank(),  
    panel.background = element_rect(fill = "white"),  
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),  
    text = element_text(size = 14)
  )




# plotting with loess (and CI and points)
ggplot(ci_loess_all, aes(x = YEAR_DAM, y = no_const, color = CONTINENT, fill = CONTINENT)) +
  geom_line() + 
  geom_point() +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.2) +  
  geom_smooth(method = "loess", span = 0.3, se = FALSE, size = 1) +  
  scale_x_continuous(breaks = seq(1880, 2025, by = 10), limits = c(1880, 2025)) + 
  labs(x = "Year", y = "Number of Dam Constructions", color = "Continent") +  
  theme_minimal() + 
  theme(
    panel.grid.major = element_line(size = 0.5, color = "lightgrey"),  
    panel.grid.minor = element_blank(),  
    panel.background = element_rect(fill = "white"),  
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),  
    text = element_text(size = 14)
  )



# plot without points but with ci
ggplot(Dam_Construction_per_year_filtered, aes(x = YEAR_DAM, y = no_const, color = CONTINENT)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.2) +  
  geom_smooth(method = "loess", span = 0.3, se = FALSE, size = 1) +  
  scale_x_continuous(breaks = seq(1880, 2024, by = 10), limits = c(1880, 2024)) +  
  labs(x = "Year", y = "Number of Dam Constructions", color = "Continent") +  
  theme_minimal() + 
  theme(
    text = element_text(size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1) 
  )



################ what we have used ########################################
# removing zeros for the GAM 
anyNA(Dam_Construction_per_year_filtered$no_const)

Dam_Construction_per_year_filtered <- Dam_Construction_per_year_filtered %>%
  filter(no_const != -0)

# GAM model --- This is the one we use!! ---- try fixing key order
ggplot(Dam_Construction_per_year_filtered, aes(x = YEAR_DAM, y = no_const, color = CONTINENT)) +
  geom_smooth(method = "gam", formula = y ~ s(x), se = FALSE, size = 1, linetype = "solid") +  
  #geom_line(alpha = 0.5) +  
 # geom_point(alpha = 0.5) +  
  scale_x_continuous(breaks = seq(1880, 2024, by = 10), limits = c(1880, 2024)) + 
  scale_y_continuous(limits = c(0, 115)) + 
  labs(x = "Year", y = "Number of Dam Constructions", color = "Continent") + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_line(size = 0.5, color = "lightgrey"),  
    panel.grid.minor = element_blank(),  
    panel.background = element_rect(fill = "white"),  
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),  
    text = element_text(size = 14)
  )



###### Add global line to the plot #####

# with GAM 

#ggplot(Dam_Construction_per_year_filtered) +
 # geom_line(aes(x = YEAR_DAM, y = no_const)) 
globalconstruction_plot <- ggplot(Dam_Construction_per_year_filtered, aes(x = YEAR_DAM, y = no_const, color = CONTINENT)) +
  stat_summary(aes(group = 1), fun = sum, geom = "line", color = "grey", alpha = 0.9, size = 1.5, linetype = "solid") +
  #geom_smooth(aes(group = 1), method = "gam", formula = y ~ s(x), se = FALSE, color = "black", size = 1.5, linetype = "solid") +  # Smoothed global total line
  geom_vline(xintercept = 1945, linetype = "dashed", color = "grey", size = 1.2) +
  geom_vline(xintercept = 1982, linetype = "dashed", color = "grey", size = 1.2) +
  geom_vline(xintercept = 2007, linetype = "dashed", color = "grey", size = 1.2) +
  geom_smooth(method = "gam", formula = y ~ s(x), se = FALSE, size = 1, linetype = "solid") +  # different continents
  #geom_line(alpha = 1, size = 1, linetype = "solid") +  # different continent lines
  #geom_point(alpha = 0.5) +  
  scale_x_continuous(breaks = seq(1880, 2020, by = 10), limits = c(1880, 2022)) + # before covid
  scale_y_continuous(limits = c(0, 400)) + 
  scale_color_viridis_d(option = "D", name = "Continent") +

  annotate("text", x = 1939.8, y = 150, label = "End of WWII\n1945", hjust = 1, size = 3.5) +
  annotate("curve", x = 1940, y = 150, xend = 1944.9, yend = 150, 
           arrow = arrow(length = unit(0.25, "cm"), type = "closed"),
           color = "black", curvature = -0.3, size = 0.8) + 
  
  annotate("text", x = 1974.8, y = 350, label = "Intensification of\nDam Removals (US)\n and Global Recession\n 1980s", hjust = 1, size = 3.5) +
  annotate("curve", x = 1975, y = 350, xend = 1981.9, yend = 350, 
           arrow = arrow(length = unit(0.25, "cm"), type = "closed"),
           color = "black", curvature = 0.3, size = 0.8) +
  
  annotate("text", x = 2015.1, y = 350, label = "The Great\nRecession\n2007-2009", hjust = 0, size = 3.5) +
  annotate("curve", x = 2007.1, y = 350, xend = 2014.8, yend = 350, 
           arrow = arrow(length = unit(0.25, "cm"), type = "closed"),
           color = "black", curvature = -0.3, size = 0.8) + 
  
  labs(x = "Year", y = "Number of Dam Constructions") + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_line(size = 0.5, color = "lightgrey"),  
    panel.grid.minor = element_blank(),  
    panel.background = element_rect(fill = "white"),  
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),  
    text = element_text(size = 14),
    legend.position = "none"
  )
print(globalconstruction_plot)






continent_colors <- c(
  "Africa" = "#871F78", 
  "Asia" = "#3288bd", 
  "Europe" = "#99d594",  
  "North America" = "#228B22", 
  "Oceania" = "#d5ee52", 
  "South America" = "#fee08b" 
)


# with LOESS
LOESSglobalconstruction_plot <- ggplot(Dam_Construction_per_year_filtered, aes(x = YEAR_DAM, y = no_const, color = CONTINENT)) +
  stat_summary(aes(group = 1), fun = sum, geom = "line", color = "grey", alpha = 0.9, size = 1.5, linetype = "solid") +
  #geom_smooth(aes(group = 1), method = "gam", formula = y ~ s(x), se = FALSE, color = "black", size = 1.5, linetype = "solid") +  # Smoothed global total line
  geom_vline(xintercept = 1945, linetype = "dashed", color = "grey", size = 1.2) +
  geom_vline(xintercept = 1982, linetype = "dashed", color = "grey", size = 1.2) +
  geom_vline(xintercept = 2007, linetype = "dashed", color = "grey", size = 1.2) +
  geom_smooth(method = "loess", span = 0.3, se = FALSE, size = 1) + 
  scale_x_continuous(breaks = seq(1880, 2022, by = 10), limits = c(1880, 2020)) + # before covid
  scale_y_continuous(limits = c(0, 400)) + 
  scale_color_manual(values = continent_colors) +

  annotate("text", x = 1939.8, y = 150, label = "End of WWII\n1945", hjust = 1, size = 5) +
  annotate("curve", x = 1940, y = 150, xend = 1944.9, yend = 150, 
           arrow = arrow(length = unit(0.25, "cm"), type = "closed"),
           color = "black", curvature = -0.3, size = 0.8) + 
  
  annotate("text", x = 1974.8, y = 350, label = "Intensification of\nDam Removals (US)\n and Global Recession\n 1980s", hjust = 1, size = 5) +
  annotate("curve", x = 1975, y = 350, xend = 1981.9, yend = 350, 
           arrow = arrow(length = unit(0.25, "cm"), type = "closed"),
           color = "black", curvature = 0.3, size = 0.8) +
  
  annotate("text", x = 2011.1, y = 310, label = "The Great\nRecession\n2007-2009", hjust = 0, size = 5) +
  annotate("curve", x = 2007.1, y = 350, xend = 2014.8, yend = 340, 
           arrow = arrow(length = unit(0.25, "cm"), type = "closed"),
           color = "black", curvature = -0.3, size = 0.8) + 
  
  labs(x = "Year", y = "Number of Dam Constructions") + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_line(size = 0.5, color = "lightgrey"),  
    panel.grid.minor = element_blank(),  
    panel.background = element_rect(fill = "white"),  
    axis.text.x = element_text(angle = 45, hjust = 1, size = 14), 
    axis.text.y = element_text(size = 14), 
    text = element_text(size = 14),
    legend.position = "none"
  )

print(LOESSglobalconstruction_plot)


### adding coloured map
#install.packages("rnaturalearth")
#install.packages("rnaturalearthdata")
library(rnaturalearth)
#library(ggplot2)

world <- ne_countries(scale = "medium", returnclass = "sf")

world <- world %>% filter(continent != "Antarctica")

world$continent[world$subregion %in% c("Caribbean", "Latin America")] <- "South America"
world$continent[world$subregion %in% c("Central America")] <- "North America"

world$continent <- as.factor(world$continent)

#Plotting the map
continent_map <- ggplot(data = world) +
  geom_sf(aes(fill = continent), color = NA) +
  scale_fill_manual(values = continent_colors) +
  theme_void() +  
  theme(legend.position = "none")


#map onto figure
finalglobal_plot <- LOESSglobalconstruction_plot +
  annotation_custom(
    ggplotGrob(continent_map), 
    xmin = 1872, xmax = 1945,  
    ymin = 250, ymax = 410    
  )

print(finalglobal_plot)
